
#include <assert.h>
#include <stdlib.h>
#include <unistd.h>

#include "psx_exe.h"
#include "decompilation.h"
#include "functions.h"
#include "from_cd.h"
#include "../../config.h"


#define SOURCES_ROOT "game_src/decompiled/"

const uint32_t funcs_80074A5C[] = {
  0x80011774,
  0x800617FC,
  0x80061820,
  0x80060FD8,
  0x800616F4,
  0x80061730,
  0x80061780,
  0x80061470,
  0x80061234,
  0x80061B00,
  0x8006171C,
  0x80060EF0,
  0x800617CC,
  0x80061DEC,
  0x80060ED8,
  0x80061F48 
};

struct jump_list_list jumps = JUMP_LIST_LIST(ARR_JUMP_LIST(
  PSXMEM_LIST(ARR_U32(0x80014BFC), 6, 0x80010A70),
  PSXMEM_LIST(ARR_U32(0x80015418), 14, 0x80010A88),
  PSXMEM_LIST(ARR_U32(0x8001D810), 8, 0x80010D58),
  PSXMEM_LIST(ARR_U32(0x8002E4BC), 6, 0x80010DD0),
  PSXMEM_LIST(ARR_U32(0x8002F458), 8, 0x80010DE8),
  PSXMEM_LIST(ARR_U32(0x80031E2C), 8, 0x80010E08),
  PSXMEM_LIST(ARR_U32(0x8003CD3C), 11, 0x80010E28),
  PSXMEM_LIST(ARR_U32(0x8003D1C4), 11, 0x80010E58),
  PSXMEM_LIST(ARR_U32(0x8003EAB4), 38, 0x80010E88),
  PSXMEM_LIST(ARR_U32(0x8003EB38), 45, 0x80010F20),
  PSXMEM_LIST(ARR_U32(0x800416A8), 45, 0x80010FD8),
  PSXMEM_LIST(ARR_U32(0x80044098), 45, 0x80011090),
  PSXMEM_LIST(ARR_U32(0x8004528C), 11, 0x80011148),
  PSXMEM_LIST(ARR_U32(0x80047BA0), 45, 0x80011178),
  PSXMEM_LIST(ARR_U32(0x800488B8), 45, 0x80011230),
  PSXMEM_LIST(ARR_U32(0x8004AC60), 38, 0x800112E8),
  PSXMEM_LIST(ARR_U32(0x80056FB0), 8, 0x80011380),
  PSXMEM_LIST(ARR_U32(0x8005CCAC), 8, 0x8001157C),
  PSXMEM_LIST(ARR_U32(0x8005CD74), 8, 0x8001159C),
  PSXMEM_LIST(ARR_U32(0x8005D1D0), 8, 0x800115BC),
  PSXMEM_LIST(ARR_U32(0x8005D2A0), 8, 0x800115DC),
  PSXMEM_LIST(ARR_U32(0x80062888), 121, 0x800119D8),
  PSXMEM_LIST(ARR_U32(0x80063294), 45, 0x80011BE4),
  PSXMEM_LIST(ARR_U32(0x8006447C), 5, 0x80011E70),
  PSXMEM_LIST(ARR_U32(0x80066668), 32, 0x80011F7C),
  PSXMEM_LIST(ARR_U32(0x80066F6C), 31, 0x800120C4),
  PSXMEM_LIST(ARR_U32(0x80067228), 31, 0x80012144),
  PSXMEM_LIST(ARR_U32(0x80069B6C), 5, 0x80075240),

  CUSTOM_LIST(ARR_U32(
    0x80014478, 0x8002F950, 0x80030484, 0x80030510, 0x8003ACD0, 0x8003ACEC, 0x8003AD38, 0x8003AD58,
    0x8003C57C, 0x8003FB2C, 0x800436A8, 0x80055880, 0x800570DC
  ), ARR_U32(
    0x800857CC, 0x8008772C, 0x80082960, 0x800872A4, 0x80081DA8, 0x8008249C, 0x8008A258, 0x8008A4D0,
    0x80088B88, 0x80083608, 0x800845F0, 0x800819BC, 0x8008B2C0, 0x8008A36C, 0x8008883C, 0x80086DD8,
    0x80083AB4, 0x80081F0C, 0x80087EF0, 0x8008465C, 0x80084718, 0x80086B38, 0x800874FC, 0x8008223C,
    0x80088E24, 0x80084B94, 0x80084620, 0x8008590C, 0x800836A8, 0x80082028, 0x80083568, 0x80085664,
    0x80083108, 0x80082F24, 0x80083690
  )), // 0x800758CC

  CUSTOM_LIST(ARR_U32(0x8002EAFC, 0x8002F47C, 0x80033AA4, 0x80042EE8, 0x8004A4A0), ARR_U32(
    0x8007D9C8, 0x8007DA78, 0x8007AE40, 0x8007DA54, 0x8007AF94, 0x8007CFB4, 0x8007E3A0, 0x8007E240,
    0x8007B4C8, 0x8007AEB8, 0x8007E398, 0x8007BB00, 0x8007B64C, 0x8007B7A8, 0x8007AF28, 0x8007E18C,
    0x8007B5DC, 0x8007AFBC, 0x8007B698, 0x8007B770, 0x8007E3C0, 0x8007B4F8, 0x8007B4DC, 0x8007B510,
    0x8007AF50, 0x8007D938, 0x8007B528, 0x8007AE5C, 0x8007AD64, 0x8007AD4C
  )), // 0x80075734

  CUSTOM_LIST(ARR_U32(
    0x80031100, 0x8003BA5C, 0x8003C810, 0x8003C838, 0x8003F250, 0x8003F398, 0x8003F458, 0x8003F4DC,
    0x8003F560, 0x8003FA90, 0x8003FAFC, 0x8003FC50, 0x80042134, 0x800421E0, 0x8004625C, 0x800463B0,
    0x800487D8, 0x80048DD8, 0x800493A0, 0x800493CC, 0x80049414, 0x800494D0, 0x80049500, 0x80049548,
    0x80049BE0, 0x80049C58, 0x800553EC, 0x80055608
  ), ARR_U32(
    0x800873E0, 0x800892C4, 0x800844A0, 0x80088F68, 0x8008391C, 0x80084128, 0x8008BFF0, 0x8008C540,
    0x8008A9A8, 0x80085184, 0x8008611C, 0x80082F58, 0x8008D2D0, 0x8008C9D8, 0x8008B0B0, 0x80089450,
    0x80085F40, 0x800836F8, 0x80089AB8, 0x800866D8, 0x800861CC, 0x8008869C, 0x800894B0, 0x80083BAC,
    0x8008AA24, 0x80086D38, 0x80086438, 0x800881D8, 0x80085254, 0x80083B8C, 0x80084EA0, 0x8008747C,
    0x80084EAC, 0x80084634, 0x80085230
  )), // 0x800758E4

  CUSTOM_LIST(ARR_U32(0x8003140C, 0x80031B98, 0x80031E00, 0x80033B20), ARR_U32(
    0x80086134, 0x80088098, 0x80083274, 0x80087E20, 0x800826F0, 0x80083330, 0x8008AE28, 0x8008B1C0,
    0x80089714, 0x80083F2C, 0x80084EF0, 0x80082300, 0x8008BE98, 0x8008AF54, 0x80089454, 0x80087B40,
    0x80084830, 0x80082AA0, 0x800888F8, 0x800853AC, 0x80085084, 0x80087400, 0x80088178, 0x80082F54,
    0x800897FC, 0x800857FC, 0x800850A0, 0x80086754, 0x80084028, 0x80082D94, 0x80083ED8, 0x80086144,
    0x80083B4C, 0x800836F0, 0x800840FC
  )), // 0x800756BC

  CUSTOM_LIST(ARR_U32(), ARR_U32(
    0x8007AEA0, 0x8007AF50, 0x8007AF2C, 0x8007B878, 0x8007B718, 0x8007B870, 0x8007B664, 0x8007B898,
    0x8007AE10
  )), // 0x800757A0

  CUSTOM_LIST(ARR_U32(), ARR_U32(
    0x8007AFDC, 0x8007B08C, 0x8007B068, 0x8007B9B4, 0x8007B854, 0x8007B9AC, 0x8007B7A0, 0x8007B9D4,
    0x8007AF4C
  )), // 0x800758A8

  CUSTOM_LIST(ARR_U32(0x800329D8), ARR_U32(
    0x8007B020, 0x8007B0D0, 0x8007B0AC, 0x8007B9F8, 0x8007B898, 0x8007B9F0, 0x8007B7E4, 0x8007BA18,
    0x8007AF90,
  )), // 0x8007574C

  CUSTOM_LIST(ARR_U32(0x8001E5D4), ARR_U32(
    0x8007CFC0, 0x8007D070, 0x8007D04C, 0x8007D998, 0x8007D838, 0x8007D990, 0x8007D784, 0x8007D9B8,
    0x8007CF30
  )), // 0x800758D8

  CUSTOM_LIST(ARR_U32(0x80042ED4, 0x8004830C, 0x8004A48C), ARR_U32(0x8007AE08)), // 0x80075694
  CUSTOM_LIST(ARR_U32(), ARR_U32(0x8007AEDC)), // 0x800757A8
  CUSTOM_LIST(ARR_U32(0x8003392C), ARR_U32(0x8007B1FC)), // 0x800757C0
  CUSTOM_LIST(ARR_U32(0x8001EE58), ARR_U32(0x8007B68C)), // 0x8007567C
  CUSTOM_LIST(ARR_U32(), ARR_U32(0x8007B4B0)), // 0x800758C4
  
  CUSTOM_LIST(ARR_U32(0x80022500, 0x80022564), ARR_U32(0x80022110, 0x80022148, 0x80022180)),

  CUSTOM_LIST(ARR_U32(0x800243FC), ARR_U32(0x80024054, 0x800240F8, 0x800241A8)),

  CUSTOM_LIST(ARR_U32(0x8004B520), ARR_U32(0x8004B528, 0x8004B538, 0x8004B548)),
  CUSTOM_LIST(ARR_U32(0x8004B588), ARR_U32(0x8004B590, 0x8004B5A0, 0x8004B5B0)),
  CUSTOM_LIST(ARR_U32(0x8004B608), ARR_U32(0x8004B610, 0x8004B620, 0x8004B630)),
  CUSTOM_LIST(ARR_U32(0x8004BC58), ARR_U32(0x8004BC60, 0x8004BC70, 0x8004BC80)),
  CUSTOM_LIST(ARR_U32(0x8004BCC0), ARR_U32(0x8004BCC8, 0x8004BCD8, 0x8004BCE8)),
  CUSTOM_LIST(ARR_U32(0x8004BD40), ARR_U32(0x8004BD48, 0x8004BD58, 0x8004BD68)),
  CUSTOM_LIST(ARR_U32(0x8004C4E4), ARR_U32(0x8004C4EC, 0x8004C4FC, 0x8004C50C)),
  CUSTOM_LIST(ARR_U32(0x8004C548), ARR_U32(0x8004C550, 0x8004C560, 0x8004C570)),
  CUSTOM_LIST(ARR_U32(0x8004C5C8), ARR_U32(0x8004C5D0, 0x8004C5E0, 0x8004C5F0)),
  CUSTOM_LIST(ARR_U32(0x8004C618), ARR_U32(0x8004C620, 0x8004C628, 0x8004C630, 0x8004C638, 0x8004C640, 0x8004C648, 0x8004C650, 0x8004C658)),
  CUSTOM_LIST(ARR_U32(0x8004C818), ARR_U32(0x8004C820, 0x8004C828, 0x8004C830)),
  CUSTOM_LIST(ARR_U32(0x8004CFA4), ARR_U32(0x8004CFAC, 0x8004CFBC, 0x8004CFCC)),
  CUSTOM_LIST(ARR_U32(0x8004D008), ARR_U32(0x8004D010, 0x8004D020, 0x8004D030)),
  CUSTOM_LIST(ARR_U32(0x8004D088), ARR_U32(0x8004D090, 0x8004D0A0, 0x8004D0B0)),
  CUSTOM_LIST(ARR_U32(0x8004D0D8), ARR_U32(0x8004D0E0, 0x8004D0E8, 0x8004D0F0, 0x8004D0F8, 0x8004D100, 0x8004D108, 0x8004D110, 0x8004D118)),
  CUSTOM_LIST(ARR_U32(0x8004D2D8), ARR_U32(0x8004D2E0, 0x8004D2E8, 0x8004D2F0)),

  CUSTOM_LIST(ARR_U32(0x8004E5B0), ARR_U32(0x8004E5B8, 0x8004E5C0, 0x8004E5C8, 0x8004E5D0)),
  CUSTOM_LIST(ARR_U32(0x8004F888), ARR_U32(0x8004F890, 0x8004F898, 0x8004F8A0, 0x8004F8A8, 0x8004F8B0,0x8004F8B8, 0x8004F8C0, 0x8004F8C8)),
  CUSTOM_LIST(ARR_U32(0x80050020), ARR_U32(0x80050028, 0x80050030, 0x80050038, 0x80050040, 0x80050048,0x80050050, 0x80050058, 0x80050060)),
  CUSTOM_LIST(ARR_U32(0x800506AC), ARR_U32(0x800506B4, 0x800506BC, 0x800506C4, 0x800506CC, 0x800506D4,0x800506DC, 0x800506E4, 0x800506EC)),

  CUSTOM_LIST(ARR_U32(0x8005DDE0), ARR_U32(0x8005DF60)),
  CUSTOM_LIST(ARR_U32(0x8005DE10), ARR_U32(0x8005E224)),
  CUSTOM_LIST(ARR_U32(0x8005DE40), ARR_U32(0x8005E804)),
  CUSTOM_LIST(ARR_U32(0x8005DE74, 0x8005DEA4), ARR_U32(0x8005E5D8)),
  CUSTOM_LIST(ARR_U32(0x8005E11C), ARR_U32(0x8006590C, 0x8005E560)),
  CUSTOM_LIST(ARR_U32(0x8005E5A8), ARR_U32(0x80053C68, 0x80067CD4)),
  CUSTOM_LIST(ARR_U32(0x8005F408), ARR_U32(funcs_80074A5C[13])),
  CUSTOM_LIST(ARR_U32(0x8005F744, 0x800600F0, 0x80060300, 0x8006032C, 0x80060498), ARR_U32(funcs_80074A5C[4])),
  CUSTOM_LIST(ARR_U32(0x8005F7B4), ARR_U32(funcs_80074A5C[15])),
  CUSTOM_LIST(ARR_U32(0x8005F964, 0x8005FA6C, 0x8005FAD0, 0x8005FB90, 0x8005FDBC, 0x8005FE64), ARR_U32(funcs_80074A5C[2])),
  CUSTOM_LIST(ARR_U32(0x8006192C), ARR_U32(
    funcs_80074A5C[3],
    funcs_80074A5C[6],
    funcs_80074A5C[7],
    funcs_80074A5C[8]
  )),

  CUSTOM_LIST(ARR_U32(0x80064938, 0x80065030, 0x8006597C), ARR_U32(0x80063A3C, 0x800659F0)),
  CUSTOM_LIST(ARR_U32(0x800659B0), ARR_U32(0x80063A14)),
  CUSTOM_LIST(ARR_U32(0x80065CA4), ARR_U32(0x80016490)),
  CUSTOM_LIST(ARR_U32(0x80068FF8), ARR_U32(0x80066634, 0x800663D8, 0x80066F34, 0x800671F0)),
  CUSTOM_LIST(ARR_U32(0x800690FC, 0x800691C8, 0x80069434, 0x80069474, 0x800694BC), ARR_U32(0x8006B64C)),
  CUSTOM_LIST(ARR_U32(0x80069780, 0x80069BB8, 0x80069BF0, 0x8006AFE0), ARR_U32(0x8006B1D8)),
  CUSTOM_LIST(ARR_U32(0x80069898, 0x800698B4), ARR_U32(0x8006B170)),
  CUSTOM_LIST(ARR_U32(0x80069A08, 0x80069A6C, 0x8006AE20, 0x8006AE7C, 0x8006AEA8), ARR_U32(0x8006B7A8)),
  CUSTOM_LIST(ARR_U32(0x80069A80, 0x8006AEBC), ARR_U32(0x8006B2CC)),
  CUSTOM_LIST(ARR_U32(0x8006AA44, 0x8006AAF4, 0x8006AB0C, 0x8006AB74, 0x8006AB8C), ARR_U32(0x8006B6D4)),
  CUSTOM_LIST(ARR_U32(0x8006AC4C, 0x8006AD5C, 0x8006AEDC, 0x8006AF54), ARR_U32(0x8006B2DC)),
  CUSTOM_LIST(ARR_U32(0x8006ACBC, 0x8006AD44), ARR_U32(0x8006B398)),
));

struct entries entries = ENTRIES(ARR_U32(
  0x8001364C,
  0x8002B9CC,
  0x8002D338,
  0x80053C68,
  0x80058BA8,
  0x8005B988,
  0x8005CFEC,
  0x8005DDF8,
  0x8005DF60,
  0x8005E03C,
  0x80061DEC,
  0x80061F48,
  0x800627D8,
  0x80069634,
  0x8006969C,
  0x8001F158,

  0x8005CA64,
  0x80013230,

  0x8002DF9C,
  0x8002EB2C,
  0x8002F3E4,
  0x8002E000,
  0x8002E084,
  0x800314B4,
  0x800324D8,
  0x80032B08,
  0x800331AC,
  0x8004A200,
  0x80054988,
  0x80037BD4,
  0x8002C420,
  0x8002C714,
));

struct skips skips = SKIPS(ARR_U32(
  0x80014564,
  0x800163E4,
  0x80014B70,
  0x80063EAC,
  0x8002D554,
  0x8002D228,
  0x8005B7D8,
  0x8003FDC8,
  0x8004DF24,
  0x80053708,
  0x80038120,
  0x80052F38,
  0x80017614,
  0x80017894,
  0x80017E54,
  0x8005CBB0,
  0x800623D8,
  0x800562A4,
  0x8006590C,
  0x80056DC4,
  0x80058C7C,
  0x800258F0,
  0x8002B390,
  0x8002B3F4,
  0x8002B444,
  0x80058CC0,
  0x8004AE38,
  0x8004BE4C,
  0x8004D5EC,
  0x8004E3C8,
  0x800522C0,
  0x800580F4,
  0x8002B4AC,
  0x8004E2E8,
  0x800584C4,
  0x800536A4,
  0x800526A8,
  0x800533D0,
  0x800529E4,
  0x80052D64,
  0x80053570,
  0x800530C0,
  0x800524C4,
  0x8006275C,
  0x8001277C,
  0x80056B28,
  0x800529CC,
  0x800144C8,
  0x80017FD4,
  0x8002C914,
  0x80037E98,
  0x80058B60,
  0x80067614,
  0x80067D74,
  0x80063AAC,
  0x8005956C,
  0x8005C7AC,
  0x800638EC,
  0x80068F30,
  0x8006815C,
  0x8006841C,
  0x80068264,
  0x80068458,
  0x80068340,
  0x80069030,
  0x8006B64C,
  0x8006A0D0,
  0x8006B2CC,
  0x8006A014,
  0x8006A99C,
  0x8006A9B0,
  0x8006A9F0,
  0x8006A2BC,
  0x8006A97C,
  0x80038074,
  0x800381BC,
  0x8006A0A4,
  0x8006BAE8,
  0x8006BB20,
  0x8006BB40,
  0x80051FEC,
  0x80016930,
  0x800168DC,
  0x80061B00,
  0x800620C4,
  0x80062090,
  0x8003C358,
  0x8003A720,
  0x8005DE8C,
  0x8005DF44,
  0x8005C588,
  0x80064094,
  0x80064198,
  0x8005C6C8,
  0x8005C6F4,
  0x80015370,
  0x8005375C,
  0x80053790,
  0x8005E224,
  0x8005DB4C,
  0x8005DBB4,
  0x8005E4AC,
  0x8005E4D8,
  0x8005E4F8,
  0x8005E604,
  0x8005E8AC,
  0x80062FC4,
  0x800684C4,
  0x800684D4,
  0x800688E0,
  0x800688F0,
  0x80068900,
  0x80068910,
  0x80016698,
  0x80016914,
  0x80016958,
  0x800169AC,
  0x80016AB4,
  0x80016C58,
  0x80016CB0,
  0x80016D2C,
  0x80016FD0,
  0x80017048,
  0x800170C0,
  0x80017110,
  0x800171FC,
  0x8001729C,
  0x80017330,
  0x80017428,
  0x800175B8,
  0x800176A0,
  0x800176C8,
  0x800176F0,
  0x80017700,
  0x80017758,
  0x8001778C,
  0x800177C0,
  0x800177F8,
  0x80017908,
  0x80017928,
  0x80017948,
  0x8001796C,
  0x80017990,
  0x800179F0,
  0x80017A38,
  0x80017AA4,
  0x80017BFC,
  0x80017C24,
  0x80017C4C,
  0x80017C84,
  0x80017CB8,
  0x80017D7C,
  0x8002BAB8,
  0x8005C720,
  0x8005F764,
  0x8005F8F8,
  0x8005FA28,
  0x8006230C,
  0x8006272C,
  0x8006276C,
  0x8006279C,
  0x80062EC0,
  0x80062F10,
  0x80063BD8,
  0x80063C48,
  0x80063D80,
  0x80067628,
  0x80067EA0,
  0x800680A4,
  0x800684B4,
  0x800684E4,
  0x800684F4,
  0x8006B670,
));


void print_psx_header(psx_header header, int depth)
{
  assert(depth > 0);
  char tabs[depth+1];
  for (int i = 0; i < depth; i++) tabs[i] = '\t';
  tabs[depth] = 0;

  printf("psx_header{\n");

  printf("%stype_name: %.8s\n", tabs, header.type_name);
  printf("%sinitial_pc: %X\n", tabs, header.initial_pc);
  printf("%sinitial_gp: %X\n", tabs, header.initial_gp);
  printf("%sdestination_address: %X\n", tabs, header.destination_address);
  printf("%sfilesize: %d\n", tabs, header.filesize);
  printf("%sdata_start: %X\n", tabs, header.data_start);
  printf("%sdata_size: %d\n", tabs, header.data_size);
  printf("%sbss_start: %X\n", tabs, header.bss_start);
  printf("%sbss_size: %d\n", tabs, header.bss_size);
  printf("%sinitial_sp_base: %X\n", tabs, header.initial_sp_base);
  printf("%sinitial_sp_offs: %d\n", tabs, header.initial_sp_offs);
  printf("%sascii_marker: %.1972s\n", tabs, header.ascii_marker);
  tabs[depth-1] = 0;
  printf("%s}\n", tabs);

  printf("code starts at: %X\n", header.initial_pc-header.destination_address+0x800);

}

int load_psx(FILE *file, char *psx_mem, psx_header *header)
{
  int err = load_sectors(file, (char *)header, 0x80000000, 53875, 1);
  if (err) return err;

  //print_psx_header(*header, 1);

  return load_sectors(file, psx_mem, header->destination_address, 53875+1, 204-1);
}

int read_psx_file(addr_list *external_calls)
{
  int err;

  char *filename = ROM_NAME;

  FILE *file = fopen(filename, "rb");
  if (file == NULL) return 1;

  char *psx_mem = malloc(0x00200000);

  uint32_t *psx_mem2 = (uint32_t *)psx_mem;
  for (int i = 0; i < 0x00200000/4; i++)
  {
    psx_mem2[i] = 0x007000D;
  }

  psx_header header;
  err = load_psx(file, psx_mem, &header);
  if (err) return err;

  err = fclose(file);
  if (err) return err;

  struct mem_range range = {
    .base = header.destination_address,
    .size = header.filesize
  };
  
  FILE *output = fopen(SOURCES_ROOT"decompilation.c", "w");
  assert(output);
  
  FILE *header_file = fopen(SOURCES_ROOT"decompilation.h", "w");
  assert(header_file);

  addr_list_sort(external_calls);
  
  struct program prog = {
    .psx_mem = psx_mem,
    .range = range,
    .entries = entries,
    .entries2n = external_calls->size,
    .entries2 = external_calls->addrs,
    .jumpss = jumps,
    .skips = skips,
    .output = output,
    .header = header_file
  };

  read_instructions(prog);
  fclose(output);
  free(psx_mem);

  return 0;
}